#!/usr/local/bin/python# -*- coding: utf-8 -*-import datetimeimport mathimport refrom ..utils import loggingfrom ..utils.constants import STOCK_MODELfrom ..utils.manage_file_util import ManageFileUtilfrom ..utils.pandas_util import PandasUtilclass ManagerSeries:    """        Class responsible for converter data from file to data frame    """    @staticmethod    def load_info_into_dataframe(file):        """            Convert the file into a dataframe to extract only relevant information and add into dataframe of series.        :return:            series_df:        """        logging.info('ManagerSeries.load_info_into_dataframe')        # Instantiate the seriesConverter        series_hist = SeriesInterpreter(file)        series_modal = series = {'TICKER': [], 'DATE': [], 'OPEN': [], 'HIGH': [], 'LOW': [], 'AVERAGE': [],                                 'CLOSE': [], 'NUM_TRADES': []}        # iterate the stock data and retrieve data from converter based on TICKER        stock_df = PandasUtil.read_file_csv(ManageFileUtil.get_folder_out()+STOCK_MODEL, encoding='ISO-8859-1')        for index, row in stock_df.iterrows():            df_ = series_hist.get_historic_isin_ticker_df(isin=row['ISIN'], ticker=row['TICKER'])            for index2, row2 in df_.iterrows():                series_modal['TICKER'].append(row2['CODNEG'])                series_modal['DATE'].append(row2['DATA'])                series_modal['OPEN'].append(row2['PREABE'])                series_modal['HIGH'].append(row2['PREMAX'])                series_modal['LOW'].append(row2['PREMIN'])                series_modal['AVERAGE'].append(row2['PREMED'])                series_modal['CLOSE'].append(row2['PREULT'])                series_modal['NUM_TRADES'].append(row2['QUATOT'])        # return the series_model dataframe as CSV        return PandasUtil.new_data_frame(data=series_modal)class SeriesInterpreter:    """        Class responsible to read the historic series from a file and return a list of shares.        Be careful with huge files!!!! just joking, this is Python.    """    def split_position_value(self, line):        self.shares['TIPREG'].append(line[0:2])        self.shares['DATA'].append(            (datetime.datetime(int(line[2:6]), int(line[6:8]), int(line[8:10]))).strftime('%d/%m/%Y'))        self.shares['CODBDI'].append(line[10:12])        self.shares['CODNEG'].append(str(line[12:24]).strip())        self.shares['TPMERC'].append(line[24:27])        self.shares['NOMRES'].append(line[27:39])        self.shares['ESPECI'].append(line[39:49])        self.shares['PRAZOT'].append(line[49:52])        self.shares['MODREF'].append(line[52:56])        self.shares['PREABE'].append(float(re.sub('[^\S]+', '0', line[56:67] + '.' + line[67:69])))        self.shares['PREMAX'].append(float(re.sub('[^\S]+', '0', line[69:80] + '.' + line[80:82])))        self.shares['PREMIN'].append(float(re.sub('[^\S]+', '0', line[82:93] + '.' + line[93:95])))        self.shares['PREMED'].append(float(re.sub('[^\S]+', '0', line[95:106] + '.' + line[106:108])))        self.shares['PREULT'].append(float(re.sub('[^\S]+', '0', line[108:119] + '.' + line[119:121])))        self.shares['PREOFC'].append(line[121:132] + '.' + line[132:134])        self.shares['PREOFV'].append(line[134:145] + '.' + line[145:147])        self.shares['TOTNEG'].append(int(line[147:152]))        self.shares['QUATOT'].append(int(line[152:170]))        self.shares['VOLTOT'].append(math.ceil(float(re.sub('[^\S]+', '0', line[170:186] + '.' + line[186:188]))))        self.shares['PREEXE'].append(line[188:199] + '.' + line[199:201])        self.shares['INDOPC'].append(line[201:202])        self.shares['DATVEN'].append(line[202:210])        self.shares['FATCOT'].append(line[210:217])        self.shares['PTOEXE'].append(line[217:230])        self.shares['CODISI'].append(str(line[230:242]).strip())        self.shares['DISMES'].append(line[242:245])    def read_file_path(self, file_name):        with open(file_name, 'r') as f:            for line in f:                if not line.startswith('00') and not line.startswith('99'):                    self.split_position_value(line)        data_frame = PandasUtil.new_data_frame(self.shares)        # first and last line is about header of the file        # data_frame = data_frame.drop([0,len(data_frame)-1], axis=0)        return data_frame.reset_index(drop=True)    def get_series(self):        return self.data_frame    def get_historic_isin_ticker_df(self, isin, ticker):        historic = self.data_frame.loc[(self.data_frame['CODISI'] == isin) & (self.data_frame['CODNEG'] == ticker)][            ['CODNEG', 'DATA', 'PREABE', 'PREMAX', 'PREMIN', 'PREMED', 'PREULT', 'TOTNEG', 'QUATOT', 'VOLTOT']]        logging.debug('Historic from {} / {} found. \n Lines ==> \n {} '.format(isin, ticker, len(historic)))        return historic    def __init__(self, path_file):        self.shares = {'TIPREG': [], 'DATA': [],                       'CODBDI': [], 'CODNEG': [], 'TPMERC': [], 'NOMRES': [],                       'ESPECI': [], 'PRAZOT': [], 'MODREF': [], 'PREABE': [],                       'PREMAX': [], 'PREMIN': [], 'PREMED': [], 'PREULT': [],                       'PREOFC': [], 'PREOFV': [], 'TOTNEG': [], 'QUATOT': [],                       'VOLTOT': [], 'PREEXE': [], 'INDOPC': [], 'DATVEN': [],                       'FATCOT': [], 'PTOEXE': [], 'CODISI': [], 'DISMES': []}        self.data_frame = self.read_file_path(path_file)        logging.info('SeriesInterpreter started with {} lines'.format(len(self.data_frame)))